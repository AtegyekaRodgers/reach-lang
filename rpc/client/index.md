[{"bookPath":"rpc","title":"Client Walkthrough","titleId":"ref-backends-rpc-client","hasOtp":true,"hasPageHeader":true},"<p>\n  <i id=\"p_0\" class=\"pid\"></i>The <a href=\"/rpc/proto/#ref-backends-rpc-proto\">Reach RPC Protocol</a> is designed to be simple to implement in languages that support HTTP and JSON interaction.\n  This document walks through the implementation of an RPC client in <a href=\"https://www.python.org\">Python</a>.\n  An example use of this library is shown in the <a href=\"/tut/rps/7-rpc/#tut-7-rpc\">tutorial section on RPC-based frontends</a>.\n  The entire library is 80 lines of code.<a href=\"#p_0\" class=\"pid\">0</a>\n</p>\n<p>\n  <i id=\"p_1\" class=\"pid\"></i>The library uses a few standard Python libraries for interacting with JSON,\n  HTTP servers, and networking:<a href=\"#p_1\" class=\"pid\">1</a>\n</p>\n<pre class=\"snippet numbered\"><div class=\"codeHeader\"><a href=\"https://github.com/reach-sh/reach-lang/tree/master/rpc-client/py/src/reach_rpc/__init__.py\">/rpc-client/py/src/reach_rpc/__init__.py</a><a class=\"far fa-copy copyBtn\" data-clipboard-text=\"# flake8: noqa\n\nimport json\nimport os\nimport requests\nimport socket\nimport time\nimport urllib3\" href=\"#\"></a></div><ol class=\"snippet\"><li value=\"1\"><span style=\"color: #6A737D\"># flake8: noqa</span></li><li value=\"2\"></li><li value=\"3\"><span style=\"color: #D73A49\">import</span><span style=\"color: #24292E\"> json</span></li><li value=\"4\"><span style=\"color: #D73A49\">import</span><span style=\"color: #24292E\"> os</span></li><li value=\"5\"><span style=\"color: #D73A49\">import</span><span style=\"color: #24292E\"> requests</span></li><li value=\"6\"><span style=\"color: #D73A49\">import</span><span style=\"color: #24292E\"> socket</span></li><li value=\"7\"><span style=\"color: #D73A49\">import</span><span style=\"color: #24292E\"> time</span></li><li value=\"8\"><span style=\"color: #D73A49\">import</span><span style=\"color: #24292E\"> urllib3</span></li><li value=\"9\"></li></ol></pre>\n<pre class=\"snippet numbered\"><div class=\"codeHeader\"><a href=\"https://github.com/reach-sh/reach-lang/tree/master/rpc-client/py/src/reach_rpc/__init__.py\">/rpc-client/py/src/reach_rpc/__init__.py</a><a class=\"far fa-copy copyBtn\" data-clipboard-text=\"def mk_rpc(opts={}):\n    def opt_of(field, envvar, default=None, f=lambda x: x):\n        opt =  f(opts.get(field))        if opts.get(field)        is not None \\\n          else f(os.environ.get(envvar)) if os.environ.get(envvar) is not None \\\n          else default\n\n        if opt is None:\n            raise RuntimeError('Mandatory configuration unset for: %s' % field)\n\n        return opt\n\n    host    = opt_of('host',    'REACH_RPC_SERVER')\n    port    = opt_of('port',    'REACH_RPC_PORT')\n    key     = opt_of('key',     'REACH_RPC_KEY')\n    timeout = opt_of('timeout', 'REACH_RPC_TIMEOUT',               f=int, default=5)\n    verify  = opt_of('verify',  'REACH_RPC_TLS_REJECT_UNVERIFIED', f=lambda x: x != '0')\" href=\"#\"></a></div><ol class=\"snippet\"><li value=\"11\"><span style=\"color: #D73A49\">def</span><span style=\"color: #24292E\"> </span><a href=\"/rpc/py/#py_mk_rpc\" title=\"py: mk_rpc\"><span style=\"color: #6F42C1\">mk_rpc</span></a><span style=\"color: #24292E\">(opts</span><span style=\"color: #D73A49\">=</span><span style=\"color: #24292E\">{}):</span></li><li value=\"12\"><span style=\"color: #24292E\">    </span><span style=\"color: #D73A49\">def</span><span style=\"color: #24292E\"> </span><span style=\"color: #6F42C1\">opt_of</span><span style=\"color: #24292E\">(field, envvar, default</span><span style=\"color: #D73A49\">=</span><span style=\"color: #005CC5\">None</span><span style=\"color: #24292E\">, f</span><span style=\"color: #D73A49\">=lambda</span><span style=\"color: #24292E\"> x: x):</span></li><li value=\"13\"><span style=\"color: #24292E\">        opt </span><span style=\"color: #D73A49\">=</span><span style=\"color: #24292E\">  f(opts.get(field))        </span><span style=\"color: #D73A49\">if</span><span style=\"color: #24292E\"> opts.get(field)        </span><span style=\"color: #D73A49\">is</span><span style=\"color: #24292E\"> </span><span style=\"color: #D73A49\">not</span><span style=\"color: #24292E\"> </span><span style=\"color: #005CC5\">None</span><span style=\"color: #24292E\"> \\</span></li><li value=\"14\"><span style=\"color: #24292E\">          </span><span style=\"color: #D73A49\">else</span><span style=\"color: #24292E\"> f(os.environ.get(envvar)) </span><span style=\"color: #D73A49\">if</span><span style=\"color: #24292E\"> os.environ.get(envvar) </span><span style=\"color: #D73A49\">is</span><span style=\"color: #24292E\"> </span><span style=\"color: #D73A49\">not</span><span style=\"color: #24292E\"> </span><span style=\"color: #005CC5\">None</span><span style=\"color: #24292E\"> \\</span></li><li value=\"15\"><span style=\"color: #24292E\">          </span><span style=\"color: #D73A49\">else</span><span style=\"color: #24292E\"> default</span></li><li value=\"16\"></li><li value=\"17\"><span style=\"color: #24292E\">        </span><span style=\"color: #D73A49\">if</span><span style=\"color: #24292E\"> opt </span><span style=\"color: #D73A49\">is</span><span style=\"color: #24292E\"> </span><span style=\"color: #005CC5\">None</span><span style=\"color: #24292E\">:</span></li><li value=\"18\"><span style=\"color: #24292E\">            </span><span style=\"color: #D73A49\">raise</span><span style=\"color: #24292E\"> </span><span style=\"color: #005CC5\">RuntimeError</span><span style=\"color: #24292E\">(</span><span style=\"color: #032F62\">'Mandatory configuration unset for: </span><span style=\"color: #005CC5\">%s</span><span style=\"color: #032F62\">'</span><span style=\"color: #24292E\"> </span><span style=\"color: #D73A49\">%</span><span style=\"color: #24292E\"> field)</span></li><li value=\"19\"></li><li value=\"20\"><span style=\"color: #24292E\">        </span><span style=\"color: #D73A49\">return</span><span style=\"color: #24292E\"> opt</span></li><li value=\"21\"></li><li value=\"22\"><span style=\"color: #24292E\">    host    </span><span style=\"color: #D73A49\">=</span><span style=\"color: #24292E\"> opt_of(</span><span style=\"color: #032F62\">'host'</span><span style=\"color: #24292E\">,    </span><span style=\"color: #032F62\">'REACH_RPC_SERVER'</span><span style=\"color: #24292E\">)</span></li><li value=\"23\"><span style=\"color: #24292E\">    port    </span><span style=\"color: #D73A49\">=</span><span style=\"color: #24292E\"> opt_of(</span><span style=\"color: #032F62\">'port'</span><span style=\"color: #24292E\">,    </span><span style=\"color: #032F62\">'REACH_RPC_PORT'</span><span style=\"color: #24292E\">)</span></li><li value=\"24\"><span style=\"color: #24292E\">    key     </span><span style=\"color: #D73A49\">=</span><span style=\"color: #24292E\"> opt_of(</span><span style=\"color: #032F62\">'key'</span><span style=\"color: #24292E\">,     </span><span style=\"color: #032F62\">'REACH_RPC_KEY'</span><span style=\"color: #24292E\">)</span></li><li value=\"25\"><span style=\"color: #24292E\">    timeout </span><span style=\"color: #D73A49\">=</span><span style=\"color: #24292E\"> opt_of(</span><span style=\"color: #032F62\">'timeout'</span><span style=\"color: #24292E\">, </span><span style=\"color: #032F62\">'REACH_RPC_TIMEOUT'</span><span style=\"color: #24292E\">,               </span><span style=\"color: #E36209\">f</span><span style=\"color: #D73A49\">=</span><span style=\"color: #005CC5\">int</span><span style=\"color: #24292E\">, </span><span style=\"color: #E36209\">default</span><span style=\"color: #D73A49\">=</span><span style=\"color: #005CC5\">5</span><span style=\"color: #24292E\">)</span></li><li value=\"26\"><span style=\"color: #24292E\">    verify  </span><span style=\"color: #D73A49\">=</span><span style=\"color: #24292E\"> opt_of(</span><span style=\"color: #032F62\">'verify'</span><span style=\"color: #24292E\">,  </span><span style=\"color: #032F62\">'REACH_RPC_TLS_REJECT_UNVERIFIED'</span><span style=\"color: #24292E\">, </span><span style=\"color: #E36209\">f</span><span style=\"color: #D73A49\">=lambda</span><span style=\"color: #24292E\"> x: x </span><span style=\"color: #D73A49\">!=</span><span style=\"color: #24292E\"> </span><span style=\"color: #032F62\">'0'</span><span style=\"color: #24292E\">)</span></li><li value=\"27\"></li></ol></pre>\n<p><i id=\"p_2\" class=\"pid\"></i>The library provides a single function, <span class=\"snip\"><a href=\"/rpc/py/#py_mk_rpc\" title=\"py: mk_rpc\"><span style=\"color: #24292E\">mk_rpc</span></a></span>, that accepts the <a href=\"/rpc/#ref-backends-rpc-opts\">Reach RPC Client Standard Options</a>.<a href=\"#p_2\" class=\"pid\">2</a></p>\n<pre class=\"snippet numbered\"><div class=\"codeHeader\"><a href=\"https://github.com/reach-sh/reach-lang/tree/master/rpc-client/py/src/reach_rpc/__init__.py\">/rpc-client/py/src/reach_rpc/__init__.py</a><a class=\"far fa-copy copyBtn\" data-clipboard-text=\"    if not verify:\n        urllib3.disable_warnings()\n        print('\\n*** Warning! TLS verification disabled! ***\\n')\n        print(' This is highly insecure in Real Lifeâ„¢ applications and must')\n        print(' only be permitted under controlled conditions (such as')\n        print(' during development).\\n')\" href=\"#\"></a></div><ol class=\"snippet\"><li value=\"28\"><span style=\"color: #24292E\">    </span><span style=\"color: #D73A49\">if</span><span style=\"color: #24292E\"> </span><span style=\"color: #D73A49\">not</span><span style=\"color: #24292E\"> verify:</span></li><li value=\"29\"><span style=\"color: #24292E\">        urllib3.disable_warnings()</span></li><li value=\"30\"><span style=\"color: #24292E\">        </span><span style=\"color: #005CC5\">print</span><span style=\"color: #24292E\">(</span><span style=\"color: #032F62\">'</span><span style=\"color: #005CC5\">\\n</span><span style=\"color: #032F62\">*** Warning! TLS verification disabled! ***</span><span style=\"color: #005CC5\">\\n</span><span style=\"color: #032F62\">'</span><span style=\"color: #24292E\">)</span></li><li value=\"31\"><span style=\"color: #24292E\">        </span><span style=\"color: #005CC5\">print</span><span style=\"color: #24292E\">(</span><span style=\"color: #032F62\">' This is highly insecure in Real Lifeâ„¢ applications and must'</span><span style=\"color: #24292E\">)</span></li><li value=\"32\"><span style=\"color: #24292E\">        </span><span style=\"color: #005CC5\">print</span><span style=\"color: #24292E\">(</span><span style=\"color: #032F62\">' only be permitted under controlled conditions (such as'</span><span style=\"color: #24292E\">)</span></li><li value=\"33\"><span style=\"color: #24292E\">        </span><span style=\"color: #005CC5\">print</span><span style=\"color: #24292E\">(</span><span style=\"color: #032F62\">' during development).</span><span style=\"color: #005CC5\">\\n</span><span style=\"color: #032F62\">'</span><span style=\"color: #24292E\">)</span></li><li value=\"34\"></li></ol></pre>\n<p>\n  <i id=\"p_3\" class=\"pid\"></i>It starts by observing the <code>verify</code> option and informing the Python library it uses for HTTPS interaction to turn off warnings.\n  It displays a warning to users that they should be nervous about using this setting.<a href=\"#p_3\" class=\"pid\">3</a>\n</p>\n<pre class=\"snippet numbered\"><div class=\"codeHeader\"><a href=\"https://github.com/reach-sh/reach-lang/tree/master/rpc-client/py/src/reach_rpc/__init__.py\">/rpc-client/py/src/reach_rpc/__init__.py</a><a class=\"far fa-copy copyBtn\" data-clipboard-text=\"    # From: https://gist.github.com/butla/2d9a4c0f35ea47b7452156c96a4e7b12\n    start_time = time.perf_counter()\n    while True:\n        try:\n            with socket.create_connection((host, port), timeout=timeout):\n                break\n        except OSError as ex:\n            time.sleep(0.01)\n            if time.perf_counter() - start_time >= timeout:\n                raise TimeoutError('Waited too long for the port {} '\n                                   'on host {} to accept connection.'\n                                   .format(port, host)) from ex\" href=\"#\"></a></div><ol class=\"snippet\"><li value=\"35\"><span style=\"color: #24292E\">    </span><span style=\"color: #6A737D\"># From: https://gist.github.com/butla/2d9a4c0f35ea47b7452156c96a4e7b12</span></li><li value=\"36\"><span style=\"color: #24292E\">    start_time </span><span style=\"color: #D73A49\">=</span><span style=\"color: #24292E\"> time.perf_counter()</span></li><li value=\"37\"><span style=\"color: #24292E\">    </span><span style=\"color: #D73A49\">while</span><span style=\"color: #24292E\"> </span><span style=\"color: #005CC5\">True</span><span style=\"color: #24292E\">:</span></li><li value=\"38\"><span style=\"color: #24292E\">        </span><span style=\"color: #D73A49\">try</span><span style=\"color: #24292E\">:</span></li><li value=\"39\"><span style=\"color: #24292E\">            </span><span style=\"color: #D73A49\">with</span><span style=\"color: #24292E\"> socket.create_connection((host, port), </span><span style=\"color: #E36209\">timeout</span><span style=\"color: #D73A49\">=</span><span style=\"color: #24292E\">timeout):</span></li><li value=\"40\"><span style=\"color: #24292E\">                </span><span style=\"color: #D73A49\">break</span></li><li value=\"41\"><span style=\"color: #24292E\">        </span><span style=\"color: #D73A49\">except</span><span style=\"color: #24292E\"> </span><span style=\"color: #005CC5\">OSError</span><span style=\"color: #24292E\"> </span><span style=\"color: #D73A49\">as</span><span style=\"color: #24292E\"> ex:</span></li><li value=\"42\"><span style=\"color: #24292E\">            time.sleep(</span><span style=\"color: #005CC5\">0.01</span><span style=\"color: #24292E\">)</span></li><li value=\"43\"><span style=\"color: #24292E\">            </span><span style=\"color: #D73A49\">if</span><span style=\"color: #24292E\"> time.perf_counter() </span><span style=\"color: #D73A49\">-</span><span style=\"color: #24292E\"> start_time </span><span style=\"color: #D73A49\">&gt;=</span><span style=\"color: #24292E\"> timeout:</span></li><li value=\"44\"><span style=\"color: #24292E\">                </span><span style=\"color: #D73A49\">raise</span><span style=\"color: #24292E\"> </span><span style=\"color: #005CC5\">TimeoutError</span><span style=\"color: #24292E\">(</span><span style=\"color: #032F62\">'Waited too long for the port </span><span style=\"color: #005CC5\">{}</span><span style=\"color: #032F62\"> '</span></li><li value=\"45\"><span style=\"color: #24292E\">                                   </span><span style=\"color: #032F62\">'on host </span><span style=\"color: #005CC5\">{}</span><span style=\"color: #032F62\"> to accept connection.'</span></li><li value=\"46\"><span style=\"color: #24292E\">                                   .format(port, host)) </span><span style=\"color: #D73A49\">from</span><span style=\"color: #24292E\"> ex</span></li><li value=\"47\"></li></ol></pre>\n<p><i id=\"p_4\" class=\"pid\"></i>Next, it attempts to connect to the Reach RPC Server and throws an error if it does not respond quickly enough.<a href=\"#p_4\" class=\"pid\">4</a></p>\n<pre class=\"snippet numbered\"><div class=\"codeHeader\"><a href=\"https://github.com/reach-sh/reach-lang/tree/master/rpc-client/py/src/reach_rpc/__init__.py\">/rpc-client/py/src/reach_rpc/__init__.py</a><a class=\"far fa-copy copyBtn\" data-clipboard-text=\"    def rpc(m, *args):\n        lab = 'RPC %s %s' % (m, json.dumps([*args]))\n        debug(lab)\n        ans = requests.post('https://%s:%s%s' % (host, port, m),\n                            json    = [*args],\n                            headers = {'X-API-Key': key},\n                            verify  = verify)\n        ans.raise_for_status()\n        debug('%s ==> %s' % (lab, json.dumps(ans.json())))\n        return ans.json()\" href=\"#\"></a></div><ol class=\"snippet\"><li value=\"52\"><span style=\"color: #24292E\">    </span><span style=\"color: #D73A49\">def</span><span style=\"color: #24292E\"> </span><a href=\"/rpc/py/#py_rpc\" title=\"py: rpc\"><span style=\"color: #6F42C1\">rpc</span></a><span style=\"color: #24292E\">(m, </span><span style=\"color: #D73A49\">*</span><span style=\"color: #24292E\">args):</span></li><li value=\"53\"><span style=\"color: #24292E\">        lab </span><span style=\"color: #D73A49\">=</span><span style=\"color: #24292E\"> </span><span style=\"color: #032F62\">'RPC </span><span style=\"color: #005CC5\">%s</span><span style=\"color: #032F62\"> </span><span style=\"color: #005CC5\">%s</span><span style=\"color: #032F62\">'</span><span style=\"color: #24292E\"> </span><span style=\"color: #D73A49\">%</span><span style=\"color: #24292E\"> (m, json.dumps([</span><span style=\"color: #D73A49\">*</span><span style=\"color: #24292E\">args]))</span></li><li value=\"54\"><span style=\"color: #24292E\">        debug(lab)</span></li><li value=\"55\"><span style=\"color: #24292E\">        ans </span><span style=\"color: #D73A49\">=</span><span style=\"color: #24292E\"> requests.post(</span><span style=\"color: #032F62\">'https://</span><span style=\"color: #005CC5\">%s</span><span style=\"color: #032F62\">:</span><span style=\"color: #005CC5\">%s%s</span><span style=\"color: #032F62\">'</span><span style=\"color: #24292E\"> </span><span style=\"color: #D73A49\">%</span><span style=\"color: #24292E\"> (host, port, m),</span></li><li value=\"56\"><span style=\"color: #24292E\">                            </span><span style=\"color: #E36209\">json</span><span style=\"color: #24292E\">    </span><span style=\"color: #D73A49\">=</span><span style=\"color: #24292E\"> [</span><span style=\"color: #D73A49\">*</span><span style=\"color: #24292E\">args],</span></li><li value=\"57\"><span style=\"color: #24292E\">                            </span><span style=\"color: #E36209\">headers</span><span style=\"color: #24292E\"> </span><span style=\"color: #D73A49\">=</span><span style=\"color: #24292E\"> {</span><span style=\"color: #032F62\">'X-API-Key'</span><span style=\"color: #24292E\">: key},</span></li><li value=\"58\"><span style=\"color: #24292E\">                            </span><span style=\"color: #E36209\">verify</span><span style=\"color: #24292E\">  </span><span style=\"color: #D73A49\">=</span><span style=\"color: #24292E\"> verify)</span></li><li value=\"59\"><span style=\"color: #24292E\">        ans.raise_for_status()</span></li><li value=\"60\"><span style=\"color: #24292E\">        debug(</span><span style=\"color: #032F62\">'</span><span style=\"color: #005CC5\">%s</span><span style=\"color: #032F62\"> ==&gt; </span><span style=\"color: #005CC5\">%s</span><span style=\"color: #032F62\">'</span><span style=\"color: #24292E\"> </span><span style=\"color: #D73A49\">%</span><span style=\"color: #24292E\"> (lab, json.dumps(ans.json())))</span></li><li value=\"61\"><span style=\"color: #24292E\">        </span><span style=\"color: #D73A49\">return</span><span style=\"color: #24292E\"> ans.json()</span></li><li value=\"62\"></li></ol></pre>\n<p>\n  <i id=\"p_5\" class=\"pid\"></i>It defines a function, <span class=\"snip\"><a href=\"/rpc/py/#py_rpc\" title=\"py: rpc\"><span style=\"color: #24292E\">rpc</span></a></span>, which will be returned later on, that\n  implements the protocol for synchronous value RPC methods.\n  It formats a given request, posts it, and then returns the deserialized result.\n  It prints debugging information for convenience.<a href=\"#p_5\" class=\"pid\">5</a>\n</p>\n<pre class=\"snippet numbered\"><div class=\"codeHeader\"><a href=\"https://github.com/reach-sh/reach-lang/tree/master/rpc-client/py/src/reach_rpc/__init__.py\">/rpc-client/py/src/reach_rpc/__init__.py</a><a class=\"far fa-copy copyBtn\" data-clipboard-text=\"    def rpc_callbacks(m, arg, cbacks):\n        vals  = {k: v    for k, v in cbacks.items() if not callable(v)}\n        meths = {k: True for k, v in cbacks.items() if     callable(v)}\n        p     = rpc(m, arg, vals, meths)\n\n        while True:\n            if p['t'] == 'Done':\n                return p\n\n            elif p['t'] == 'Kont':\n                cback = cbacks[p['m']]\n                ans   = cback(*p['args'])\n                p     = rpc('/kont', p['kid'], ans)\n\n            else:\n                raise Exception('Illegal callback return: %s' % json.dumps(p))\" href=\"#\"></a></div><ol class=\"snippet\"><li value=\"63\"><span style=\"color: #24292E\">    </span><span style=\"color: #D73A49\">def</span><span style=\"color: #24292E\"> </span><a href=\"/rpc/py/#py_rpc_callbacks\" title=\"py: rpc_callbacks\"><span style=\"color: #6F42C1\">rpc_callbacks</span></a><span style=\"color: #24292E\">(m, arg, cbacks):</span></li><li value=\"64\"><span style=\"color: #24292E\">        vals  </span><span style=\"color: #D73A49\">=</span><span style=\"color: #24292E\"> {k: v    </span><span style=\"color: #D73A49\">for</span><span style=\"color: #24292E\"> k, v </span><span style=\"color: #D73A49\">in</span><span style=\"color: #24292E\"> cbacks.items() </span><span style=\"color: #D73A49\">if</span><span style=\"color: #24292E\"> </span><span style=\"color: #D73A49\">not</span><span style=\"color: #24292E\"> </span><span style=\"color: #005CC5\">callable</span><span style=\"color: #24292E\">(v)}</span></li><li value=\"65\"><span style=\"color: #24292E\">        meths </span><span style=\"color: #D73A49\">=</span><span style=\"color: #24292E\"> {k: </span><span style=\"color: #005CC5\">True</span><span style=\"color: #24292E\"> </span><span style=\"color: #D73A49\">for</span><span style=\"color: #24292E\"> k, v </span><span style=\"color: #D73A49\">in</span><span style=\"color: #24292E\"> cbacks.items() </span><span style=\"color: #D73A49\">if</span><span style=\"color: #24292E\">     </span><span style=\"color: #005CC5\">callable</span><span style=\"color: #24292E\">(v)}</span></li><li value=\"66\"><span style=\"color: #24292E\">        p     </span><span style=\"color: #D73A49\">=</span><span style=\"color: #24292E\"> rpc(m, arg, vals, meths)</span></li><li value=\"67\"></li><li value=\"68\"><span style=\"color: #24292E\">        </span><span style=\"color: #D73A49\">while</span><span style=\"color: #24292E\"> </span><span style=\"color: #005CC5\">True</span><span style=\"color: #24292E\">:</span></li><li value=\"69\"><span style=\"color: #24292E\">            </span><span style=\"color: #D73A49\">if</span><span style=\"color: #24292E\"> p[</span><span style=\"color: #032F62\">'t'</span><span style=\"color: #24292E\">] </span><span style=\"color: #D73A49\">==</span><span style=\"color: #24292E\"> </span><span style=\"color: #032F62\">'Done'</span><span style=\"color: #24292E\">:</span></li><li value=\"70\"><span style=\"color: #24292E\">                </span><span style=\"color: #D73A49\">return</span><span style=\"color: #24292E\"> p</span></li><li value=\"71\"></li><li value=\"72\"><span style=\"color: #24292E\">            </span><span style=\"color: #D73A49\">elif</span><span style=\"color: #24292E\"> p[</span><span style=\"color: #032F62\">'t'</span><span style=\"color: #24292E\">] </span><span style=\"color: #D73A49\">==</span><span style=\"color: #24292E\"> </span><span style=\"color: #032F62\">'Kont'</span><span style=\"color: #24292E\">:</span></li><li value=\"73\"><span style=\"color: #24292E\">                cback </span><span style=\"color: #D73A49\">=</span><span style=\"color: #24292E\"> cbacks[p[</span><span style=\"color: #032F62\">'m'</span><span style=\"color: #24292E\">]]</span></li><li value=\"74\"><span style=\"color: #24292E\">                ans   </span><span style=\"color: #D73A49\">=</span><span style=\"color: #24292E\"> cback(</span><span style=\"color: #D73A49\">*</span><span style=\"color: #24292E\">p[</span><span style=\"color: #032F62\">'args'</span><span style=\"color: #24292E\">])</span></li><li value=\"75\"><span style=\"color: #24292E\">                p     </span><span style=\"color: #D73A49\">=</span><span style=\"color: #24292E\"> rpc(</span><span style=\"color: #032F62\">'/kont'</span><span style=\"color: #24292E\">, p[</span><span style=\"color: #032F62\">'kid'</span><span style=\"color: #24292E\">], ans)</span></li><li value=\"76\"></li><li value=\"77\"><span style=\"color: #24292E\">            </span><span style=\"color: #D73A49\">else</span><span style=\"color: #24292E\">:</span></li><li value=\"78\"><span style=\"color: #24292E\">                </span><span style=\"color: #D73A49\">raise</span><span style=\"color: #24292E\"> </span><span style=\"color: #005CC5\">Exception</span><span style=\"color: #24292E\">(</span><span style=\"color: #032F62\">'Illegal callback return: </span><span style=\"color: #005CC5\">%s</span><span style=\"color: #032F62\">'</span><span style=\"color: #24292E\"> </span><span style=\"color: #D73A49\">%</span><span style=\"color: #24292E\"> json.dumps(p))</span></li><li value=\"79\"></li></ol></pre>\n<p>\n  <i id=\"p_6\" class=\"pid\"></i>It defines a function, <span class=\"snip\"><a href=\"/rpc/py/#py_rpc_callbacks\" title=\"py: rpc_callbacks\"><span style=\"color: #24292E\">rpc_callbacks</span></a></span>, which will be returned later on, that\n  implements the protocol for interactive RPC methods.\n  On lines 64 and 65, this function inspects its third argument, <span class=\"snip\"><span style=\"color: #24292E\">cbacks</span></span>,\n  and separates the <span class=\"snip\"><span style=\"color: #005CC5\">callable</span></span> arguments from the values and creates the\n  intermediate objects, <span class=\"snip\"><span style=\"color: #24292E\">vals</span></span> and <span class=\"snip\"><span style=\"color: #24292E\">meths</span></span>, to provide the RPC\n  invocation.\n  After it makes the call, in the <span class=\"snip\"><span style=\"color: #D73A49\">while</span></span> loop starting on line 68, it\n  inspects the result to determine if it is a final answer or an\n  interactive RPC callback.\n  If it is a callback, as indicated by the test on line 72, then it extracts the\n  name of the method, <span class=\"snip\"><span style=\"color: #24292E\">p[</span><span style=\"color: #032F62\">'m'</span><span style=\"color: #24292E\">]</span></span>, and invokes it in the original third\n  argument, <span class=\"snip\"><span style=\"color: #24292E\">cbacks</span></span>, with the provided arguments.\n  It replaces the <span class=\"snip\"><span style=\"color: #24292E\">p</span></span> value with the result of that continuation invocation and continues.<a href=\"#p_6\" class=\"pid\">6</a>\n</p>\n<pre class=\"snippet numbered\"><div class=\"codeHeader\"><a href=\"https://github.com/reach-sh/reach-lang/tree/master/rpc-client/py/src/reach_rpc/__init__.py\">/rpc-client/py/src/reach_rpc/__init__.py</a><a class=\"far fa-copy copyBtn\" data-clipboard-text=\"    return rpc, rpc_callbacks\" href=\"#\"></a></div><ol class=\"snippet\"><li value=\"80\"><span style=\"color: #24292E\">    </span><span style=\"color: #D73A49\">return</span><span style=\"color: #24292E\"> rpc, rpc_callbacks</span></li></ol></pre>\n<p><i id=\"p_7\" class=\"pid\"></i>Finally, it returns <span class=\"snip\"><a href=\"/rpc/py/#py_rpc\" title=\"py: rpc\"><span style=\"color: #24292E\">rpc</span></a></span> and <span class=\"snip\"><a href=\"/rpc/py/#py_rpc_callbacks\" title=\"py: rpc_callbacks\"><span style=\"color: #24292E\">rpc_callbacks</span></a></span> to the user.<a href=\"#p_7\" class=\"pid\">7</a></p>","<ul><li class=\"dynamic\"><a href=\"#ref-backends-rpc-client\">Client Walkthrough</a></li></ul>"]